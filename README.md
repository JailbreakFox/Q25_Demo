# 四足机器人 UDP 控制 Demo (Windows 版)

本目录包含四足机器人的 Windows 平台 UDP 控制示例程序，演示如何通过 UDP 协议与机器人通信。

## 编译环境

- Windows 10/11
- Visual Studio 2017 或更高版本（或支持 C++11 的编译器）
- CMake 3.14 或更高版本

## 编译方法

```powershell
# 在项目根目录执行
mkdir build
cd build
cmake .. -G "Visual Studio 17 2022" -A x64
cmake --build . --config Release
```

编译完成后，可执行文件位于 `build/windows/release/bin/` 目录。

## 网络配置

### 控制命令发送（Client 模式）

机器人默认 IP 地址为 `192.168.3.20`，端口为 `43893`。

确保本机与机器人在同一网段（192.168.3.x）。

### 状态数据接收（Server 模式）

接收机器人上报的状态数据需要配置网络：

| 配置方式 | 说明 |
|----------|------|
| **方式一** | 将本机 IP 配置为 `192.168.3.157`，监听端口 `43893` |
| **方式二** | 参考《天狼Q25 Ultra 软件接口规格说明书.docx》修改机器人本体的目标 IP/端口，使其与本机一致 |

---

## Demo 列表

### 1. stand_lie_demo.exe - 站立/趴下控制

**功能**: 演示机器人站立和趴下的基本控制。

**流程**:
1. 启动 2Hz 心跳
2. 发送站立命令
3. 等待 3 秒
4. 发送趴下命令

---

### 2. axis_control_demo.exe - 摇杆轴控制

**功能**: 演示通过摇杆轴值控制机器人移动和转向。

**控制方式**:
| 轴 | 功能 | 死区范围 |
|----|------|----------|
| 左摇杆 Y 轴 | 前进/后退 | -6553 ~ 6553 |
| 左摇杆 X 轴 | 左移/右移 | -24576 ~ 24576 |
| 右摇杆 X 轴 | 左转/右转 | -28212 ~ 28212 |

**流程**:
1. 启动心跳
2. 前进 1 秒
3. 后退 1 秒
4. 左转 2 秒
5. 右转 2 秒
6. 左移/右移各 1 秒

---

### 2.1. axis_control_demo_new.exe - 扩展指令摇杆控制

**功能**: 使用扩展指令协议（0x21010140）一次性发送四个轴值控制机器人。

**与 axis_control_demo 的区别**:
| 特性 | axis_control_demo | axis_control_demo_new |
|------|-------------------|----------------------|
| 协议 | 单轴指令（4个命令） | 扩展指令（1个命令） |
| 命令码 | 0x21010130/0x21010131/0x21010135 | 0x21010140 |
| 轴值范围 | [-1000, 1000] | [-1000, 1000] |
| 死区 | 有 | 无 |

**指令结构**:
```cpp
struct CommandHead {
    uint32_t command_type;   // 1 = 扩展指令
    uint32_t command_code;   // 0x21010140
    uint32_t parameter_size; // sizeof(AxisCommand) = 16
};

struct AxisCommand {
    uint32_t left_x;   // 平移摇杆X轴值
    uint32_t left_y;   // 平移摇杆Y轴值
    uint32_t right_x;  // 转向摇杆X轴值
    uint32_t right_y;  // 转向摇杆Y轴值
};
```

**流程**:
1. 启动心跳
2. 发送站立命令
3. 前进 1 秒
4. 后退 1 秒
5. 左转 2 秒
6. 右转 2 秒

---

### 3. motion_mode_demo.exe - 运动模式切换

**功能**: 演示切换机器人的运动模式。

**支持的模式**:
| 模式 | 命令码 | 说明 |
|------|--------|------|
| 遥控模式 | 0x21010C02 | 响应手动控制指令 |
| 导航模式 | 0x21010C03 | 执行自主导航任务 |
| 辅助模式 | 0x21010C04 | 进入辅助控制模式 |

---

### 4. gait_switch_demo.exe - 步态切换

**功能**: 演示切换机器人的行走步态。

**支持的步态**:
| 步态 | 命令码 | 说明 |
|------|--------|------|
| Walk | 0x21010300 | 稳定四足行走，适用于平坦地面 |
| Trot/Run | 0x21010423 | 对角步态，速度更快 |

---

### 5. emergency_stop_demo.exe - 急停控制

**功能**: 演示发送急停命令使机器人立即停止。

**说明**:
- 急停后机器人会进入安全趴下状态
- 需要重新发送站立命令才能恢复运动
- 适用于紧急情况

---

### 6. height_control_demo.exe - 高度调节

**功能**: 演示调节机器人身体高度。

**高度级别**:
| 级别 | 参数值 | 说明 |
|------|--------|------|
| 低 | 0 | 重心较低，更稳定 |
| 中 | 1 | 默认高度 |
| 高 | 2 | 视野更好，稳定性略降 |

---

### 7. auto_charge_demo.exe - 自主充电

**功能**: 演示启动和停止自主充电任务。

**前提条件**:
- 机器人需要先处于导航模式
- 充电桩位置已在地图中标记

**任务参数**:
| 参数 | 值 | 说明 |
|------|-----|------|
| 启动 | 0 | 开始自主充电任务 |
| 停止 | 1 | 取消充电任务 |

---

### 8. power_control_demo.exe - 设备电源控制

**功能**: 演示控制机器人各设备的电源开关。

**可控设备**:
| 设备 | 命令码 | 说明 |
|------|--------|------|
| 前上雷达 | 0x80110501 | LIDAR Front Upper |
| 前下雷达 | 0x80110502 | LIDAR Front Lower |
| 后上雷达 | 0x80110503 | LIDAR Back Upper |
| 后下雷达 | 0x80110504 | LIDAR Back Lower |
| 外挂电脑 | 0x80110801 | Upload Computer |
| 驱动电机 | 0x80110201 | Driver Motor |

**参数**: 0 = 关闭, 1 = 开启

---

### 9. status_receiver_demo.exe - 状态接收

**功能**: 接收机器人主动上报的状态数据。

**网络配置**（重要）:

> **配置方式一**: 将本机 IP 配置为 `192.168.3.157`，监听端口 `43893`
>
> **配置方式二**: 参考《天狼Q25 Ultra 软件接口规格说明书.docx》修改机器人本体的目标 IP/端口，使其与本机一致

**接收的数据类型**:
- 电池信息：电量、电压、电流、温度
- IMU 数据：姿态角、角速度、加速度
- 关节数据：位置、速度、力矩、温度
- 运动状态：当前步态、运动模式、速度等

**退出**: 按 `Ctrl+C` 停止接收

---

## 通用代码结构

所有 Demo 遵循统一的代码结构：

```cpp
// 1. Windows 头文件
#include <winsock2.h>
#include <ws2tcpip.h>
#pragma comment(lib, "ws2_32.lib")

// 2. 配置区
const char* ROBOT_IP = "192.168.3.20";
const int ROBOT_PORT = 43893;

// 3. 命令码定义
constexpr uint32_t CMD_HEARTBEAT = 0x21040001;
// ...

// 4. UDP命令结构体
#pragma pack(push, 1)
struct UDPCommand {
    uint32_t code;
    uint32_t parameters_size;
    uint32_t type;
};
#pragma pack(pop)

// 5. UDP发送函数（使用 Winsock2）
void sendCommand(const char* ip, int port, uint32_t cmd_code, int32_t param = 0);

// 6. 心跳线程（2Hz）
void heartbeatThread();

// 7. 主函数（包含 WSAStartup/WSACleanup）
int main() {
    WSADATA wsaData;
    WSAStartup(MAKEWORD(2, 2), &wsaData);
    // ... 业务逻辑 ...
    WSACleanup();
}
```

## 心跳机制

所有控制类 Demo 都包含心跳机制：

- **频率**: 2Hz（每 500ms 发送一次）
- **命令码**: 0x21040001
- **作用**: 维持与机器人的通信连接，机器人在一定时间内未收到心跳会进入保护状态

## 注意事项

1. **安全第一**: 测试前确保机器人周围有足够空间
2. **心跳必须**: 发送任何控制命令前必须先启动心跳
3. **网络连通**: 确保本机与机器人网络连通
4. **防火墙**: 确保 Windows 防火墙允许 UDP 端口 43893 通信
5. **急停准备**: 随时准备使用急停命令或物理急停按钮

## 命令码速查表

| 功能 | 命令码 | 参数 |
|------|--------|------|
| 心跳 | 0x21040001 | 无 |
| 站立 | 0x21010202 | 无 |
| 趴下 | 0x21010222 | 无 |
| 急停 | 0x21010C0E | 无 |
| 遥控模式 | 0x21010C02 | 无 |
| 导航模式 | 0x21010C03 | 无 |
| Walk步态 | 0x21010300 | 无 |
| Run步态 | 0x21010423 | 无 |
| 高度调节 | 0x21010406 | 0/1/2 |
| 左摇杆Y轴 | 0x21010130 | 轴值 |
| 左摇杆X轴 | 0x21010131 | 轴值 |
| 右摇杆X轴 | 0x21010135 | 轴值 |
| 扩展轴控 | 0x21010140 | AxisCommand结构 |
| 自主充电 | 0x91910250 | 0=启动, 1=停止 |


